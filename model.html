<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M322VJCV0H"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-M322VJCV0H');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dire Wolf 3D Models - Interactive Anatomical Study</title>
    <meta name="description" content="Explore interactive 3D models of Dire Wolves with detailed anatomical annotations. Compare with modern wolves and view dynamic simulations of this prehistoric predator.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Three.js Library - Using CDN (specific version for compatibility) -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.151.3/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.151.3/examples/jsm/"
        }
    }
    </script>
    
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .model-container {
            height: 500px;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .model-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }
        /* Loading animation */
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Progress bar styles */
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 20px;
            background-color: #3b82f6;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s ease;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation Bar -->
    <nav class="bg-gray-900 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold">Dire Wolf Education</div>
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="hover:text-gray-300">Home</a>
                <a href="science.html" class="hover:text-gray-300">Science</a>
                <a href="model.html" class="text-blue-400 hover:text-blue-300">3D Models</a>
                <a href="fossil.html" class="hover:text-gray-300">Fossils</a>
                <a href="games.html" class="hover:text-gray-300">Games</a>
                <a href="conservation.html" class="hover:text-gray-300">Conservation</a>
            </div>
            <div class="md:hidden">
                <button class="text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Page Title -->
    <header class="bg-gray-800 text-white py-16">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">3D Model Display</h1>
            <p class="text-xl text-gray-300">Explore the Dire Wolf's anatomy and dynamic simulations in 360°</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        <!-- 3D Model Display Section -->
        <section class="mb-16">
            <div class="model-container" id="modelContainer">
                <div id="loadingText" class="absolute inset-0 flex items-center justify-center z-10"></div>
                <div id="progressContainer" class="absolute bottom-16 left-0 right-0 mx-8 hidden">
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="model-controls">
                    <button id="rotateBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Rotate</button>
                    <button id="zoomBtn" class="bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition">Zoom</button>
                    <button id="panBtn" class="bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition">Pan</button>
                    <button id="resetBtn" class="bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition">Reset</button>
                </div>
            </div>
            
            <!-- Model Upload Section -->
            <div class="bg-white rounded-lg shadow p-4 my-4">
                <h3 class="text-lg font-bold mb-2">模型选择</h3>
                <p class="text-gray-600 mb-4 text-sm">选择一个内置模型或上传您自己的3D模型文件。</p>
                
                <!-- 添加预设模型选择按钮 -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="loadStandardModel" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">加载标准模型</button>
                    <button id="loadSkeletonModel" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">加载骨架模型</button>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-semibold mb-2">上传自定义模型</h4>
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <div class="flex-1">
                            <input type="file" id="modelUpload" accept=".glb,.gltf" class="block w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        </div>
                        <button id="uploadModelBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">上传模型</button>
                    </div>
                </div>
                
                <div id="modelInfo" class="mt-4 text-sm text-gray-600 hidden">
                    <div class="bg-gray-100 p-3 rounded">
                        <h4 class="font-semibold mb-1">模型信息:</h4>
                        <ul class="list-disc list-inside" id="modelInfoList">
                            <li>状态: <span id="modelStatus">未加载</span></li>
                            <li>三角形: <span id="modelTriangles">0</span></li>
                            <li>顶点: <span id="modelVertices">0</span></li>
                            <li>材质: <span id="modelMaterials">0</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Debug Panel (for troubleshooting) -->
            <div class="bg-white rounded-lg shadow p-4 my-4 border-l-4 border-yellow-500">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold mb-2">Debugging Information</h3>
                    <button id="toggleDebugBtn" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">Show/Hide</button>
                </div>
                <div id="debugPanel" class="hidden">
                    <div class="bg-gray-100 p-3 rounded text-xs font-mono overflow-auto max-h-64 mb-2">
                        <h4 class="font-semibold mb-1">Log:</h4>
                        <pre id="debugLog" class="whitespace-pre-wrap">Loading debug information...</pre>
                    </div>
                    
                    <div class="mt-3">
                        <h4 class="font-semibold mb-1 text-sm">Model Path Tests:</h4>
                        <div id="pathTestsContainer" class="grid grid-cols-2 gap-2 text-xs">
                            <!-- Path test results will be added here -->
                        </div>
                    </div>
                    
                    <div class="flex mt-4 gap-2">
                        <button id="testPathsBtn" class="bg-blue-500 text-white text-xs px-3 py-1 rounded hover:bg-blue-600">Run Path Tests</button>
                        <button id="clearLogBtn" class="bg-gray-500 text-white text-xs px-3 py-1 rounded hover:bg-gray-600">Clear Log</button>
                        <button id="tryModelBtn" class="bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600">Load Model Manually</button>
                    </div>
                </div>
            </div>
            
            <!-- Three.js Scripts -->
            <script type="module">
                // Import Three.js modules
                import * as THREE from 'three';
                import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
                import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
                
                // 全局保存导入的构造函数
                const ThreeOrbitControls = OrbitControls;
                const ThreeGLTFLoader = GLTFLoader; // 保存GLTFLoader构造函数
                
                // Initialize Three.js scene
                let scene, camera, renderer, controls, model;
                let controlMode = 'rotate'; // Default control mode is rotation
                let loadingStatus = document.getElementById('loadingText');
                
                // Debug functionality
                let debugLog = [];
                
                // Custom console logger to capture debug info
                const originalConsoleLog = console.log;
                const originalConsoleError = console.error;
                const originalConsoleWarn = console.warn;
                
                // Override console methods to capture logs
                console.log = function() {
                    debugLog.push({type: 'log', message: Array.from(arguments).join(' '), time: new Date().toISOString()});
                    updateDebugPanel();
                    originalConsoleLog.apply(console, arguments);
                };
                
                console.error = function() {
                    debugLog.push({type: 'error', message: Array.from(arguments).join(' '), time: new Date().toISOString()});
                    updateDebugPanel();
                    originalConsoleError.apply(console, arguments);
                };
                
                console.warn = function() {
                    debugLog.push({type: 'warn', message: Array.from(arguments).join(' '), time: new Date().toISOString()});
                    updateDebugPanel();
                    originalConsoleWarn.apply(console, arguments);
                };
                
                // Update debug panel with logs
                function updateDebugPanel() {
                    const logElement = document.getElementById('debugLog');
                    if (logElement) {
                        logElement.innerHTML = debugLog.map(entry => {
                            const color = entry.type === 'error' ? 'text-red-500' : 
                                         entry.type === 'warn' ? 'text-yellow-500' : 'text-gray-700';
                            return `<div class="${color}">[${entry.time.split('T')[1].split('.')[0]}] ${entry.message}</div>`;
                        }).join('\n');
                        
                        // Auto-scroll to bottom
                        logElement.scrollTop = logElement.scrollHeight;
                    }
                }
                
                // Add debug panel event listeners after DOM loads
                document.addEventListener('DOMContentLoaded', () => {
                    // Toggle debug panel
                    document.getElementById('toggleDebugBtn').addEventListener('click', () => {
                        const debugPanel = document.getElementById('debugPanel');
                        debugPanel.classList.toggle('hidden');
                    });
                    
                    // Clear debug log
                    document.getElementById('clearLogBtn').addEventListener('click', () => {
                        debugLog = [];
                        updateDebugPanel();
                    });
                    
                    // Test paths button
                    document.getElementById('testPathsBtn').addEventListener('click', async () => {
                        console.log('Running manual path tests...');
                        const pathsToTest = [
                            'direwolf.glb',
                            './direwolf.glb',
                            '/direwolf.glb',
                            '../direwolf.glb',
                            'models/direwolf.glb',
                            './models/direwolf.glb',
                            '/models/direwolf.glb',
                            window.location.href.replace(/[^/]*$/, '') + 'direwolf.glb',
                            window.location.href.replace(/[^/]*$/, '') + 'models/direwolf.glb'
                        ];
                        
                        const container = document.getElementById('pathTestsContainer');
                        container.innerHTML = '';
                        
                        for (const path of pathsToTest) {
                            const div = document.createElement('div');
                            div.className = 'bg-gray-200 p-2 rounded flex justify-between';
                            div.innerHTML = `
                                <span class="truncate" title="${path}">${path}</span>
                                <span class="loading">Testing...</span>
                            `;
                            container.appendChild(div);
                            
                            try {
                                const response = await fetch(path, { method: 'HEAD' });
                                div.className = response.ok ? 
                                    'bg-green-100 p-2 rounded flex justify-between' : 
                                    'bg-red-100 p-2 rounded flex justify-between';
                                div.querySelector('.loading').textContent = response.ok ? 
                                    'Found ✓' : `Not found (${response.status})`;
                            } catch (error) {
                                div.className = 'bg-red-100 p-2 rounded flex justify-between';
                                div.querySelector('.loading').textContent = `Error: ${error.message}`;
                            }
                        }
                    });
                    
                    // Try loading model manually
                    document.getElementById('tryModelBtn').addEventListener('click', () => {
                        console.log('手动加载模型');
                        const useSimplifiedModel = confirm('是否要加载内置的简化模型？\n点击"确定"加载简化模型，点击"取消"输入自定义路径。');
                        
                        if (useSimplifiedModel) {
                            // 直接创建并显示简化模型
                            showFallbackModel({
                                body: 0x8B4513,   // 棕色
                                head: 0x6B4226,   // 深棕色
                                legs: 0x8B4513,   // 棕色
                                tail: 0x8B4513    // 棕色
                            });
                        } else {
                            // 提示用户输入路径
                            const path = prompt('请输入模型路径:', 'models/direwolf.glb');
                            if (path) {
                                console.log(`手动尝试从路径加载模型: ${path}`);
                                // 如果已有模型则移除
                                if (model && scene) {
                                    scene.remove(model);
                                }
                                
                                // 直接加载模型，不检查文件是否存在
                                loadModelWithGLTF(path, 0, [path]);
                            }
                        }
                    });
                });
                
                // Add file existence check (for debugging)
                async function checkFileExists(url) {
                    console.log(`检查文件是否存在: ${url}`);
                    try {
                        const response = await fetch(url, { method: 'HEAD', cache: 'no-store' });
                        const exists = response.ok;
                        console.log(`文件 ${url} ${exists ? '存在' : '不存在'} (状态码: ${response.status})`);
                        return exists;
                    } catch (error) {
                        console.warn(`检查文件存在出错: ${url}`, error.message);
                        // 如果报错，尝试使用GET方法请求一小部分文件
                        try {
                            const response = await fetch(url, { 
                                method: 'GET', 
                                headers: { 'Range': 'bytes=0-1024' },
                                cache: 'no-store'
                            });
                            const exists = response.ok;
                            console.log(`文件 ${url} ${exists ? '存在(GET)' : '不存在(GET)'} (状态码: ${response.status})`);
                            return exists;
                        } catch (e) {
                            console.error(`第二次检查文件存在出错: ${url}`, e.message);
                            return false;
                        }
                    }
                }
                
                // 重写tryLoadingFromMultiplePaths函数
                async function tryLoadingFromMultiplePaths(paths, currentIndex = 0) {
                    if (currentIndex >= paths.length) {
                        console.error('所有路径都加载失败:', paths);
                        loadingStatus.textContent = '加载模型失败。查看调试面板了解详情。';
                        loadingStatus.style.color = 'red';
                        
                        // 所有路径都失败，使用简化模型
                        showFallbackModel();
                        return;
                    }

                    const path = paths[currentIndex];
                    console.log(`尝试从路径加载模型: ${path} (${currentIndex + 1}/${paths.length})`);
                    
                    // 直接尝试加载模型，不预先检查文件存在
                    // 这样可以避免本地文件系统CORS问题
                    loadModelWithGLTF(path, currentIndex, paths);
                }

                // Load model with error handling
                function loadModelWithGLTF(modelPath, currentPathIndex, allPaths) {
                    console.log(`加载模型: ${modelPath}`);
                    
                    // Set a loading timeout (15 seconds)
                    const loadingTimeout = setTimeout(() => {
                        console.error(`模型加载超时: ${modelPath}`);
                        tryLoadingFromMultiplePaths(allPaths, currentPathIndex + 1);
                    }, 15000);
                    
                    const progressContainer = document.getElementById('progressContainer');
                    const progressBar = document.getElementById('progressBar');
                    progressContainer.classList.remove('hidden');
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    
                    // Progress tracking
                    const onProgress = (event) => {
                        if (event.lengthComputable) {
                            const percentComplete = Math.round((event.loaded / event.total) * 100);
                            progressBar.style.width = `${percentComplete}%`;
                            progressBar.textContent = `${percentComplete}%`;
                            console.log(`加载进度: ${percentComplete}%`);
                        }
                    };

                    try {
                        // 创建GLTFLoader实例
                        const loader = new ThreeGLTFLoader();
                        
                        loader.load(
                            modelPath,
                            (gltf) => {
                                clearTimeout(loadingTimeout);
                                console.log('模型加载成功!');
                                
                                // Hide progress
                                progressContainer.classList.add('hidden');
                                loadingStatus.textContent = '模型加载成功！';
                                loadingStatus.style.color = 'green';
                                
                                // 清除之前的模型
                                if (model && scene) {
                                    scene.remove(model);
                                }
                                
                                model = gltf.scene;
                                scene.add(model);
                                
                                // Display model information
                                const modelInfo = document.getElementById('modelInfo');
                                const modelStatus = document.getElementById('modelStatus');
                                const modelTriangles = document.getElementById('modelTriangles');
                                const modelVertices = document.getElementById('modelVertices');
                                const modelMaterials = document.getElementById('modelMaterials');
                                
                                modelInfo.classList.remove('hidden');
                                modelStatus.textContent = '加载成功';
                                modelStatus.style.color = 'green';
                                
                                // Count triangles, vertices, and materials
                                let triangleCount = 0;
                                let vertexCount = 0;
                                let materialCount = 0;
                                const materials = new Set();
                                
                                model.traverse((child) => {
                                    if (child.isMesh) {
                                        if (child.geometry) {
                                            if (child.geometry.index) {
                                                triangleCount += child.geometry.index.count / 3;
                                            } else if (child.geometry.attributes.position) {
                                                triangleCount += child.geometry.attributes.position.count / 3;
                                            }
                                            
                                            if (child.geometry.attributes.position) {
                                                vertexCount += child.geometry.attributes.position.count;
                                            }
                                        }
                                        
                                        if (child.material) {
                                            if (Array.isArray(child.material)) {
                                                child.material.forEach(mat => materials.add(mat));
                                            } else {
                                                materials.add(child.material);
                                            }
                                        }
                                    }
                                });
                                
                                materialCount = materials.size;
                                
                                modelTriangles.textContent = triangleCount.toLocaleString();
                                modelVertices.textContent = vertexCount.toLocaleString();
                                modelMaterials.textContent = materialCount;
                                
                                // Center model
                                const box = new THREE.Box3().setFromObject(model);
                                const center = box.getCenter(new THREE.Vector3());
                                const size = box.getSize(new THREE.Vector3());
                                
                                // Calculate scale to normalize model size
                                const maxDim = Math.max(size.x, size.y, size.z);
                                const scale = 5 / maxDim;
                                model.scale.set(scale, scale, scale);
                                
                                // Reset position to center
                                model.position.x = -center.x * scale;
                                model.position.y = -center.y * scale;
                                model.position.z = -center.z * scale;
                                
                                // Initialize annotations
                                initializeAnnotations(model);
                                
                                // Update camera 
                                updateCamera();
                                
                                // Start animation if not already running
                                if (!window.animationFrameId) {
                                    animate();
                                }
                                
                                // 几秒后隐藏提示
                                setTimeout(function() {
                                    loadingStatus.textContent = '';
                                }, 3000);
                            },
                            onProgress,
                            (error) => {
                                clearTimeout(loadingTimeout);
                                console.error(`模型加载错误 ${modelPath}:`, error.message);
                                progressContainer.classList.add('hidden');
                                
                                // Try next path
                                tryLoadingFromMultiplePaths(allPaths, currentPathIndex + 1);
                            }
                        );
                    } catch (error) {
                        clearTimeout(loadingTimeout);
                        console.error(`GLTFLoader创建或加载时出错: ${modelPath}`, error);
                        progressContainer.classList.add('hidden');
                        
                        // Try next path
                        tryLoadingFromMultiplePaths(allPaths, currentPathIndex + 1);
                    }
                }

                // Initialize scene and attempt to load model
                function init() {
                    console.log('正在初始化3D场景...');
                    
                    // 确保调试面板默认显示
                    document.getElementById('debugPanel').classList.remove('hidden');
                    
                    // 确定基础URL
                    const baseUrl = window.location.href.replace(/[^/]*$/, '');
                    
                    // 创建待尝试路径列表（按优先顺序）
                    const modelPaths = [
                        './models/direwolf.glb',        // 首先尝试相对路径到models目录
                        'models/direwolf.glb',          // 其次尝试models目录
                        './direwolf.glb',               // 尝试根目录(相对路径)
                        'direwolf.glb',                 // 尝试根目录
                        '../models/direwolf.glb',       // 尝试父目录的models
                        '../direwolf.glb',              // 尝试父目录
                        baseUrl + 'models/direwolf.glb',// 尝试绝对路径到models
                        baseUrl + 'direwolf.glb',       // 尝试绝对路径到根目录
                        '/models/direwolf.glb',         // 尝试服务器根目录
                        '/direwolf.glb'                 // 尝试服务器根目录
                    ];
                    
                    console.log('将尝试的模型路径:', modelPaths);
                    
                    // 设置场景、相机、渲染器
                    scene = new THREE.Scene();
                    scene.background = new THREE.Color(0xf0f0f0);
                    
                    // 优先使用容器尺寸而非窗口尺寸
                    const container = document.getElementById('modelContainer');
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    
                    camera = new THREE.PerspectiveCamera(45, containerWidth / containerHeight, 0.1, 1000);
                    camera.position.set(0, 0, 10);
                    
                    // 添加环境光
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    scene.add(ambientLight);
                    
                    // 添加方向光
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);
                    
                    try {
                        // 创建渲染器
                        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                        renderer.setSize(containerWidth, containerHeight);
                        renderer.setPixelRatio(window.devicePixelRatio);
                        
                        // 清除之前的渲染器
                        const existingCanvas = container.querySelector('canvas');
                        if (existingCanvas) {
                            container.removeChild(existingCanvas);
                        }
                        
                        container.appendChild(renderer.domElement);
                        
                        // 控制器
                        controls = new ThreeOrbitControls(camera, renderer.domElement);
                        controls.enableDamping = true;
                        controls.dampingFactor = 0.05;
                    } catch (error) {
                        console.error('创建渲染器失败:', error);
                        loadingStatus.innerHTML = `
                            <div class="loading-container">
                                <p class="text-red-600 font-bold">WebGL错误</p>
                                <p class="text-gray-800">${error.message}</p>
                                <p class="text-gray-600 mt-2">您的浏览器可能不支持WebGL。</p>
                            </div>
                        `;
                        return;
                    }

                    // 重置按钮事件监听
                    const resetBtn = document.getElementById('resetBtn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', resetControls);
                    }
                    
                    // 加载标准模型按钮
                    const loadStandardBtn = document.getElementById('loadStandardModel');
                    if (loadStandardBtn) {
                        loadStandardBtn.addEventListener('click', () => {
                            console.log('加载标准模型');
                            loadingStatus.textContent = '正在加载标准模型...';
                            
                            // 获取当前页面的完整路径
                            const currentPath = window.location.pathname;
                            const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
                            
                            // 使用绝对路径
                            const modelPathsToTry = [
                                basePath + 'models/direwolf.glb',
                                basePath + 'direwolf.glb',
                                './models/direwolf.glb',
                                'models/direwolf.glb'
                            ];
                            
                            // 如果已有模型则移除
                            if (model && scene) {
                                scene.remove(model);
                            }
                            
                            tryLoadingFromMultiplePaths(modelPathsToTry);
                        });
                        console.log('标准模型按钮事件监听器已添加');
                    } else {
                        console.error('找不到标准模型按钮元素');
                    }
                    
                    // 加载骨架模型按钮
                    const loadSkeletonBtn = document.getElementById('loadSkeletonModel');
                    if (loadSkeletonBtn) {
                        loadSkeletonBtn.addEventListener('click', () => {
                            console.log('加载骨架模型');
                            loadingStatus.textContent = '正在加载骨架模型...';
                            
                            // 获取当前页面的完整路径
                            const currentPath = window.location.pathname;
                            const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
                            
                            // 使用绝对路径
                            const modelPathsToTry = [
                                basePath + 'models/direwolf-skeleton.glb',
                                basePath + 'direwolf-skeleton.glb',
                                './models/direwolf-skeleton.glb',
                                'models/direwolf-skeleton.glb'
                            ];
                            
                            // 如果已有模型则移除
                            if (model && scene) {
                                scene.remove(model);
                            }
                            
                            tryLoadingFromMultiplePaths(modelPathsToTry);
                        });
                        console.log('骨架模型按钮事件监听器已添加');
                    } else {
                        console.error('找不到骨架模型按钮元素');
                    }
                    
                    // 处理文件上传
                    const uploadBtn = document.getElementById('uploadModelBtn');
                    if (uploadBtn) {
                        uploadBtn.addEventListener('click', handleModelUpload);
                        console.log('上传模型按钮事件监听器已添加');
                    } else {
                        console.error('找不到上传模型按钮元素');
                    }
                    
                    // 直接加载本地模型
                    tryLoadingFromMultiplePaths(modelPaths);
                    
                    // 处理窗口大小调整
                    window.addEventListener('resize', onWindowResize);
                    
                    // 添加控制模式按钮的事件监听
                    document.getElementById('rotateBtn').addEventListener('click', function() {
                        setControlMode('rotate');
                    });
                    
                    document.getElementById('zoomBtn').addEventListener('click', function() {
                        setControlMode('zoom');
                    });
                    
                    document.getElementById('panBtn').addEventListener('click', function() {
                        setControlMode('pan');
                    });
                    
                    document.getElementById('resetBtn').addEventListener('click', resetControls);
                }
                
                // 修改动画循环函数
                function animate() {
                    try {
                        window.animationFrameId = requestAnimationFrame(animate);
                        if (controls) controls.update();
                        if (renderer && scene && camera) {
                            renderer.render(scene, camera);
                        }
                    } catch (error) {
                        console.error('动画循环错误:', error);
                        cancelAnimationFrame(window.animationFrameId);
                    }
                }

                // 添加调试功能：查看THREE.js版本和WebGL信息
                function checkWebGLCapabilities() {
                    try {
                        const canvas = document.createElement('canvas');
                        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                        
                        if (!gl) {
                            return {
                                supported: false,
                                error: 'WebGL不受支持'
                            };
                        }
                        
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        return {
                            supported: true,
                            vendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR),
                            renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER),
                            version: gl.getParameter(gl.VERSION),
                            shadingLanguage: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
                            extensions: gl.getSupportedExtensions()
                        };
                    } catch (error) {
                        return {
                            supported: false,
                            error: error.message
                        };
                    }
                }

                // 添加诊断工具按钮事件处理
                document.addEventListener('DOMContentLoaded', () => {
                    // 获取WebGL信息
                    const webglInfo = checkWebGLCapabilities();
                    console.log('WebGL信息:', webglInfo);
                    
                    // 添加WebGL信息到调试面板
                    const debugLog = document.getElementById('debugLog');
                    if (debugLog) {
                        debugLog.innerHTML += '\n---- WebGL信息 ----\n';
                        if (webglInfo.supported) {
                            debugLog.innerHTML += `支持状态: 支持\n`;
                            debugLog.innerHTML += `供应商: ${webglInfo.vendor}\n`;
                            debugLog.innerHTML += `渲染器: ${webglInfo.renderer}\n`;
                            debugLog.innerHTML += `版本: ${webglInfo.version}\n`;
                            debugLog.innerHTML += `着色语言: ${webglInfo.shadingLanguage}\n`;
                        } else {
                            debugLog.innerHTML += `支持状态: 不支持\n`;
                            debugLog.innerHTML += `错误: ${webglInfo.error}\n`;
                        }
                    }
                });
                
                // 确保正确执行resetControls函数
                function resetControls() {
                    console.log('重置视图');
                    
                    if (!model || !scene || !camera || !controls) {
                        console.warn('无法重置 - 模型或场景未初始化');
                        return;
                    }
                    
                    try {
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3()).length();
                        const center = box.getCenter(new THREE.Vector3());
                        
                        // 重置模型位置
                        model.position.x = -center.x;
                        model.position.y = -center.y;
                        model.position.z = -center.z;
                        
                        // 重置相机位置
                        camera.position.copy(center);
                        camera.position.x += size / 2.0;
                        camera.position.y += size / 5.0;
                        camera.position.z += size / 2.0;
                        camera.lookAt(center);
                        
                        // 重置控制器
                        controls.reset();
                        
                        console.log('视图已重置');
                    } catch (error) {
                        console.error('重置视图失败:', error);
                    }
                }
                
                // 更新onWindowResize函数
                function onWindowResize() {
                    try {
                        const container = document.getElementById('modelContainer');
                        const width = container.clientWidth;
                        const height = container.clientHeight;
                        
                        if (camera) {
                            camera.aspect = width / height;
                            camera.updateProjectionMatrix();
                        }
                        
                        if (renderer) {
                            renderer.setSize(width, height);
                        }
                    } catch (error) {
                        console.error('调整窗口大小失败:', error);
                    }
                }
                
                // 修复updateCamera函数
                function updateCamera() {
                    if (!model || !camera) return;
                    
                    try {
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3()).length();
                        const center = box.getCenter(new THREE.Vector3());
                        
                        camera.position.copy(center);
                        camera.position.x += size / 2.0;
                        camera.position.y += size / 5.0;
                        camera.position.z += size / 2.0;
                        camera.lookAt(center);
                        camera.updateProjectionMatrix();
                    } catch (error) {
                        console.error('更新相机失败:', error);
                    }
                }
                
                // 添加模型注释初始化
                function initializeAnnotations(model) {
                    // 占位函数 - 可以在这里实现模型注释功能
                    console.log('模型注释初始化');
                }
                
                // Control mode setting function
                function setControlMode(mode) {
                    console.log(`切换控制模式: ${mode}`);
                    controlMode = mode;
                    
                    if (!controls) {
                        console.warn('控制器未初始化，无法设置模式');
                        return;
                    }
                    
                    // 根据控制模式设置控制器旋转、缩放和平移限制
                    switch(mode) {
                        case 'rotate':
                            controls.enableRotate = true;
                            controls.enableZoom = false;
                            controls.enablePan = false;
                            break;
                        case 'zoom':
                            controls.enableRotate = false;
                            controls.enableZoom = true;
                            controls.enablePan = false;
                            break;
                        case 'pan':
                            controls.enableRotate = false;
                            controls.enableZoom = false;
                            controls.enablePan = true;
                            break;
                    }
                    
                    // 高亮当前选中的按钮
                    document.querySelectorAll('.model-controls button').forEach(btn => {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-white', 'text-gray-800');
                    });
                    
                    document.getElementById(mode + 'Btn').classList.remove('bg-white', 'text-gray-800');
                    document.getElementById(mode + 'Btn').classList.add('bg-blue-600', 'text-white');
                }
                
                // 若所有路径都失败，创建并显示一个彩色的后备模型
                function showFallbackModel(colorOptions) {
                    console.log('显示简化后备模型');
                    loadingStatus.innerHTML = `
                        <div class="loading-container">
                            <p class="text-yellow-600 font-bold">使用简化模型</p>
                            <p class="text-gray-800">显示内置简化版本。</p>
                        </div>
                    `;
                    
                    // 默认颜色设置
                    const colors = colorOptions || {
                        body: 0x666666,
                        head: 0x555555,
                        legs: 0x666666,
                        tail: 0x666666
                    };
                    
                    try {
                        // 确保场景已初始化
                        if (!scene) {
                            console.log('场景未初始化，创建新场景');
                            scene = new THREE.Scene();
                            scene.background = new THREE.Color(0xf0f0f0);
                        }
                        
                        // 如果已有模型则移除
                        if (model) {
                            scene.remove(model);
                        }
                        
                        // 创建简单的狼形状
                        const group = new THREE.Group();
                        
                        // 身体
                        const bodyGeometry = new THREE.BoxGeometry(1.5, 0.8, 0.6);
                        const bodyMaterial = new THREE.MeshStandardMaterial({ color: colors.body });
                        const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                        group.add(body);
                        
                        // 头部
                        const headGeometry = new THREE.BoxGeometry(0.6, 0.5, 0.5);
                        const headMaterial = new THREE.MeshStandardMaterial({ color: colors.head });
                        const head = new THREE.Mesh(headGeometry, headMaterial);
                        head.position.x = 1.0;
                        group.add(head);
                        
                        // 腿部
                        const legGeometry = new THREE.BoxGeometry(0.2, 0.8, 0.2);
                        const legMaterial = new THREE.MeshStandardMaterial({ color: colors.legs });
                        
                        const frontLegLeft = new THREE.Mesh(legGeometry, legMaterial);
                        frontLegLeft.position.set(0.5, -0.8, 0.2);
                        group.add(frontLegLeft);
                        
                        const frontLegRight = new THREE.Mesh(legGeometry, legMaterial);
                        frontLegRight.position.set(0.5, -0.8, -0.2);
                        group.add(frontLegRight);
                        
                        const backLegLeft = new THREE.Mesh(legGeometry, legMaterial);
                        backLegLeft.position.set(-0.5, -0.8, 0.2);
                        group.add(backLegLeft);
                        
                        const backLegRight = new THREE.Mesh(legGeometry, legMaterial);
                        backLegRight.position.set(-0.5, -0.8, -0.2);
                        group.add(backLegRight);
                        
                        // 尾巴
                        const tailGeometry = new THREE.BoxGeometry(0.8, 0.1, 0.1);
                        const tailMaterial = new THREE.MeshStandardMaterial({ color: colors.tail });
                        const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                        tail.position.set(-1.0, 0, 0);
                        tail.rotation.y = -Math.PI / 8; // 使尾巴稍微倾斜
                        group.add(tail);
                        
                        // 确保场景中有光源
                        const existingLights = scene.children.filter(child => 
                            child.isAmbientLight || child.isDirectionalLight);
                            
                        if (existingLights.length === 0) {
                            console.log('添加光源到场景');
                            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                            scene.add(ambientLight);
                            
                            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                            directionalLight.position.set(1, 1, 1);
                            scene.add(directionalLight);
                        }
                        
                        // 添加模型到场景
                        scene.add(group);
                        model = group;
                        
                        // 确保相机已初始化
                        if (!camera) {
                            console.log('相机未初始化，创建新相机');
                            const container = document.getElementById('modelContainer');
                            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
                        }
                        
                        // 确保渲染器已初始化
                        if (!renderer) {
                            console.log('渲染器未初始化，创建新渲染器');
                            const container = document.getElementById('modelContainer');
                            renderer = new THREE.WebGLRenderer({ antialias: true });
                            renderer.setSize(container.clientWidth, container.clientHeight);
                            container.appendChild(renderer.domElement);
                        }
                        
                        // 确保控制器已初始化
                        if (!controls && renderer) {
                            console.log('控制器未初始化，创建新控制器');
                            controls = new ThreeOrbitControls(camera, renderer.domElement);
                            controls.enableDamping = true;
                            controls.dampingFactor = 0.05;
                        }
                        
                        // 调整相机位置
                        camera.position.set(3, 1.5, 3);
                        camera.lookAt(0, 0, 0);
                        
                        // 设置默认控制模式
                        setControlMode('rotate');
                        
                        // 确保动画循环在运行
                        if (!window.animationFrameId) {
                            animate();
                        }
                        
                        // 显示模型信息
                        const modelInfo = document.getElementById('modelInfo');
                        const modelStatus = document.getElementById('modelStatus');
                        const modelTriangles = document.getElementById('modelTriangles');
                        const modelVertices = document.getElementById('modelVertices');
                        const modelMaterials = document.getElementById('modelMaterials');
                        
                        if (modelInfo && modelStatus && modelTriangles && modelVertices && modelMaterials) {
                            modelInfo.classList.remove('hidden');
                            modelStatus.textContent = '使用简化模型';
                            modelStatus.style.color = 'orange';
                            modelTriangles.textContent = '32';
                            modelVertices.textContent = '56';
                            modelMaterials.textContent = '2';
                        }
                        
                        console.log('简化模型已创建并显示');
                        return true;
                    } catch (error) {
                        console.error('创建简化模型失败:', error);
                        loadingStatus.innerHTML += `<p class="text-red-600">创建简化模型失败: ${error.message}</p>`;
                        return false;
                    }
                }

                // 修改文件上传处理
                function handleModelUpload() {
                    const fileInput = document.getElementById('modelUpload');
                    const file = fileInput.files[0];
                    
                    console.log('处理模型上传');
                    
                    if (file) {
                        console.log(`正在加载上传的模型: ${file.name}`);
                        loadingStatus.textContent = `正在加载上传的模型: ${file.name}`;
                        
                        // 为上传的文件创建URL
                        try {
                            const fileURL = URL.createObjectURL(file);
                            
                            // 如果已有模型则移除
                            if (model && scene) {
                                scene.remove(model);
                            }
                            
                            // 直接加载模型，不需要检查文件是否存在
                            loadModelWithGLTF(fileURL, 0, [fileURL]);
                        } catch (error) {
                            console.error('创建对象URL出错:', error);
                            loadingStatus.innerHTML = `
                                <div class="loading-container">
                                    <p class="text-red-600 font-bold">文件加载错误</p>
                                    <p class="text-gray-800">${error.message}</p>
                                </div>
                            `;
                        }
                    } else {
                        alert('请选择GLB或GLTF文件上传');
                    }
                }

                // 确保直接从页面加载开始就显示内容
                window.addEventListener('DOMContentLoaded', () => {
                    // 初始化
                    console.log('DOM完全加载，开始初始化...');
                    init();
                    
                    // 检查按钮是否正确监听事件
                    setTimeout(() => {
                        const testButtons = ['loadStandardModel', 'loadSkeletonModel', 'uploadModelBtn'];
                        testButtons.forEach(id => {
                            const btn = document.getElementById(id);
                            if (btn) {
                                console.log(`按钮 ${id} 存在`);
                                // 添加测试点击效果
                                btn.addEventListener('mousedown', function() {
                                    this.style.backgroundColor = '#3b82f6'; // 点击时变色
                                });
                                btn.addEventListener('mouseup', function() {
                                    this.style.backgroundColor = '#2563eb'; // 松开时恢复
                                });
                            } else {
                                console.error(`按钮 ${id} 不存在`);
                            }
                        });
                    }, 1000);
                    
                    // 如果5秒后仍未看到模型，显示简化版本
                    setTimeout(() => {
                        if (!model || !scene.children.some(child => child === model)) {
                            console.log('5秒后未检测到模型，显示简化版本');
                            showFallbackModel({
                                body: 0x8B4513,   // 棕色
                                head: 0x6B4226,   // 深棕色
                                legs: 0x8B4513,   // 棕色
                                tail: 0x8B4513    // 棕色
                            });
                        }
                    }, 5000);
                });
            </script>
        </section>

        <!-- View Options -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8">View Options</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Skeletal View</h3>
                    <p class="text-gray-600 mb-4">Examine the complete skeletal structure and unique anatomical features of the Dire Wolf</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Switch to Skeletal View</button>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Muscular View</h3>
                    <p class="text-gray-600 mb-4">Observe the muscular system and understand the powerful movement capabilities</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Switch to Muscular View</button>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">External View</h3>
                    <p class="text-gray-600 mb-4">Appreciate the external features, including fur patterns and body proportions</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Switch to External View</button>
                </div>
            </div>
        </section>

        <!-- Dynamic Simulations -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8">Dynamic Simulations</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Walking Animation</h3>
                    <p class="text-gray-600 mb-4">Observe the Dire Wolf's walking gait and movement patterns</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Play Walking Animation</button>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Running Animation</h3>
                    <p class="text-gray-600 mb-4">Watch the Dire Wolf's running motion and experience its speed and power</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Play Running Animation</button>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Hunting Posture</h3>
                    <p class="text-gray-600 mb-4">Simulate hunting scenarios and understand predatory strategies</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Play Hunting Animation</button>
                </div>
            </div>
        </section>

        <!-- Anatomical Annotations -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8">Anatomical Annotations</h2>
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">Body Parts</h3>
                        <ul class="space-y-2 text-gray-600">
                            <li>Cranial Structure</li>
                            <li>Vertebral System</li>
                            <li>Limb Bones</li>
                            <li>Dental Features</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Feature Description</h3>
                        <p class="text-gray-600">Click on annotation points to view detailed descriptions of each anatomical feature, including structural characteristics and functions.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modern Wolf Comparison -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8">Modern Wolf Comparison</h2>
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">Size Comparison</h3>
                        <p class="text-gray-600">Compare the physical dimensions of Dire Wolves and modern gray wolves, including body length, shoulder height, and weight.</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Anatomical Comparison</h3>
                        <p class="text-gray-600">Compare skeletal structures, muscular systems, and dental features to understand evolutionary changes.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">About Us</h3>
                    <p class="text-gray-400">Dedicated to spreading knowledge about Dire Wolves and promoting paleontological education</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-400 hover:text-white">Home</a></li>
                        <li><a href="science.html" class="text-gray-400 hover:text-white">Science</a></li>
                        <li><a href="model.html" class="text-blue-400 hover:text-blue-300">3D Models</a></li>
                        <li><a href="fossil.html" class="text-gray-400 hover:text-white">Fossils</a></li>
                        <li><a href="games.html" class="text-gray-400 hover:text-white">Games</a></li>
                        <li><a href="conservation.html" class="text-gray-400 hover:text-white">Conservation</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Contact Us</h3>
                    <p class="text-gray-400">Email: xinqianlin51@gmail.com</p>
                    <p class="text-gray-400">Phone: +86 18150636869</p>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                <p>© 2025 Dire Wolf Education. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html> 